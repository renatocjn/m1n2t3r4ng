
<nav id="main-navbar" class="navbar navbar-expand-md navbar-dark bg-dark rounded">
  <span class="navbar-brand">
      <%= image_tag "logo_casebras.png", height: "35px", width: "35px" %>
      MST
      <span class="d-none d-lg-inline text-sm text-white">Monitoramento de Serviços de Tecnologia</span>
  </span>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" data-toggle="modal" data-target="#newDeviceModal"><%= fa_icon(:server, text: "Novo dispositivo") %></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-toggle="modal" data-target="#newServiceModal"><%= fa_icon(:eye, text: "Novo sensor") %></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-toggle="modal" data-target="#settingsModal"><%= fa_icon(:cog, text: "Configurações") %></a>
      </li>
      <li class="nav-item">
        <%= link_to fa_icon("sign-out-alt", text: "Sair"), logoff_path, class: "btn btn-danger" %>
      </li>
    </ul>
  </div>
</nav>

<div class="modal fade" id="newDeviceModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= render "devices/form" %>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configurações do sistema</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= render "settings_form" %>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="newServiceModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= render "monitored_services/form" %>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between mt-3 mb-1">
  <div id="status-counters d-sm-block d-none">
    <div class="status-counter status-counter-up" data-toggle="tooltip" data-html="true" data-placement="right" title="Número de serviços online">
      <span class="counter-value"><%=@status_counter[:up]%></span>
    </div>
    <div class="status-counter status-counter-warning" data-toggle="tooltip" data-html="true" data-placement="right" title="Número de serviços com latência alta">
      <span class="counter-value"><%=@status_counter[:warning]%></span>
    </div>
    <div class="status-counter status-counter-down" data-toggle="tooltip" data-html="true" data-placement="right" title="Número de serviços offline">
      <span class="counter-value"><%=@status_counter[:down]%></span>
    </div>
  </div>
  
  <div id="panel-commands" class="d-sm-inline-flex justify-content-end flex-wrap d-none ">
    <% refresh_intervals = {"30 segundos" => 30.seconds.to_i, "1 minuto" => 1.minute.to_i, "10 minutos" => 10.minutes.to_i, "1 hora" => 1.hour.to_i} %>
    <% warning_delays = {"100ms" => 0.1, "200ms" => 0.2, "500ms" => 0.5, "1s" => 1} %>
    
    <button id="mute-audio-bttn" class="btn btn-light text-success"  data-toggle="tooltip" title="Notificações ativadas" data-placement="bottom">
      <i class="fas fa-bell"></i>
    </button>
    
    <button id="unmute-audio-bttn" class="btn btn-light text-danger" data-toggle="tooltip" title="Notificações desativadas" data-placement="bottom">
      <i class="fas fa-bell-slash"></i>
    </button>
    
    <%= button_to "/refresh_panel.js", remote: true, data: {"disable-with" => "Atualizando..."}, id: "refresh_bttn", class: "btn btn-success ", method: :get do %>
      <%= fa_icon "sync-alt" %>
      <span class="d-none d-md-inline">Atualizar</span>
    <% end %>
    
    <%= button_to "/force_ping.js", remote: true, data: {"disable-with" => "Pingando..."}, id: "force_ping_bttn", class: "btn btn-primary", method: :get do %>
      <%= fa_icon "play" %>
      <span class="d-none d-md-inline">Forçar medição</span>
    <% end %>
    
    <div class="d-inline">
      <%= simple_form_for Setting, url: root_path, remote: true, wrapper: :inline_form, html: { class: 'form-inline d-inline' } do |f| %>
        <%= f.input :refresh_ratio, as: :select, collection: refresh_intervals, include_blank: false, label: false, input_html: {:onchange=>'$(this.form).submit();', title: "Tempo entre atualizações da página", "data-toggle"=>"tooltip", "data-html"=>"true", "data-placement"=>"bottom"} %>
      <% end %>
    </div>
    
    <div class="d-inline">
      <%= simple_form_for Setting, url: root_path, remote: true, wrapper: :inline_form, html: { class: 'form-inline d-inline' } do |f| %>
        <%= f.input :warning_delay, as: :select, collection: warning_delays, include_blank: false, label: false, input_html: {:onchange=>'$(this.form).submit();', title: "Intervalo de tempo considerado de alta latência", "data-toggle"=>"tooltip", "data-html"=>"true", "data-placement"=>"bottom"} %>
      <% end %>
    </div>
  </div>
</div>

<hr>
<%# TODO find a way to remove devices in ungrouped mode %>
<div id='service-container' class="d-flex justify-content-start flex-wrap">
  <% if Setting.group_services %>
    <% @devices.each do |device| %>
      <%= render partial: "device", locals: {device: device}%>
    <% end %>
  <% else %>
    <% @monitored_services.each do |service| %>
      <%= render partial: "monitored_service", locals: {service: service}%>
    <% end %>
  <% end %>
</div>

<%# TODO Test these audio events%>
<%= audio_tag "down-service.wav", id:"down_service_audio" %>
<%= audio_tag "up-service.wav", id:"up_service_audio" %>

<script>
  <%= render "update_refresh_delay.js" %>
</script>
